<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Bayan Chat ‚Äî English with AI Bayan 4grade II</title>
<style>
  body{
    font-family:Verdana,sans-serif;
    background:linear-gradient(180deg,#fff6e5 0%,#f3e0b8 100%);
    margin:0;color:#002b5c;text-align:center;
  }
  header{
    background:#003366;
    color:white;
    padding:1rem;
    border-bottom:5px solid gold;
  }
  #statusBar{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    background:#fff9e5;
    border-bottom:2px solid gold;
    padding:6px;
  }
  #statusLogo{
    width:40px;
    height:40px;
    border-radius:50%;
    border:2px solid gold;
    object-fit:cover;
  }
  #status{
    font-size:0.95rem;
    font-weight:bold;
  }
  #chatBox{
    max-width:700px;
    margin:10px auto;
    background:white;
    border:2px solid gold;
    border-radius:12px;
    padding:10px;
    height:360px;
    overflow-y:auto;
    text-align:left;
    font-size:0.95rem;
  }
  .msg{margin:6px 0;padding:6px 10px;border-radius:10px;line-height:1.4;}
  .user{background:#e3f2fd;border-left:3px solid #1565c0;}
  .ai{background:#fff8e1;border-left:3px solid gold;}
  textarea{
    width:95%;
    max-width:700px;
    margin-top:10px;
    min-height:60px;
    border-radius:10px;
    border:1px solid #ccc;
    font-family:inherit;
    font-size:1rem;
    padding:6px;
  }
  .btn{
    display:inline-block;
    margin:6px;
    padding:8px 14px;
    border-radius:10px;
    border:none;
    background:#003366;
    color:white;
    font-weight:bold;
    cursor:pointer;
  }
  .btn:hover{background:gold;color:#003366;}
  #micStatus{font-size:0.85rem;color:#555;margin-top:5px;}
</style>
</head>
<body>

<header>
  <h1>üí¨ AI Bayan ‚Äî Online + Offline Auto</h1>
  <p style="font-size:0.9rem;margin:0;">English with AI Bayan 4grade II</p>
</header>

<div id="statusBar">
  <img id="statusLogo" src="logo.png" alt="AI Bayan Logo">
  <span id="status">üü¢ Online AI Connected</span>
</div>

<main>
  <div id="chatBox"></div>
  <textarea id="chatInput" placeholder="Type your question here..."></textarea><br>
  <button class="btn" onclick="askBayan()">Ask AI Bayan</button>
  <button class="btn" onclick="clearChat()">Clear</button>
  <button class="btn" onclick="startSpeech()">üéôÔ∏è Speak</button>
  <p id="micStatus"></p>
</main>

<script>
async function askBayan(){
  const input=document.getElementById('chatInput');
  const box=document.getElementById('chatBox');
  const status=document.getElementById('status');
  const question=input.value.trim();
  if(!question){alert("Type your question first.");return;}
  addMsg("user",question);
  addMsg("ai","<i>AI Bayan is thinking...</i>");

  try{
    const controller=new AbortController();
    // –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ 15 —Å–µ–∫—É–Ω–¥
    const timeoutId=setTimeout(()=>controller.abort(),15000);
    const response=await fetch("https://shiny-tree-f78c.aiko030500.workers.dev",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      signal:controller.signal,
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:[
          {role:"system",content:"You are AI Bayan, a kind English teacher for 4th grade kids in Kazakhstan."},
          {role:"user",content:question}
        ]
      })
    });
    clearTimeout(timeoutId);
    if(!response.ok)throw new Error("Server error");
    const data=await response.json();
    const answer=data.choices?.[0]?.message?.content||"";
    removeThinking();
    if(answer){
      addMsg("ai",answer);
      bayanSpeak(answer);
      status.innerHTML="üü¢ Online AI Connected";
      status.style.color="green";
    } else throw new Error("Empty");
  }catch{
    removeThinking();
    const offlineAnswer=getOfflineAnswer(question);
    addMsg("ai","<b>(Offline)</b> "+offlineAnswer);
    bayanSpeak(offlineAnswer);
    status.innerHTML="üî¥ Offline Mode Active";
    status.style.color="red";
  }
}

function addMsg(role,text){
  const box=document.getElementById('chatBox');
  box.innerHTML+=`<p class="msg ${role}"><b>${role==="user"?"You":"AI Bayan"}:</b> ${text}</p>`;
  box.scrollTop=box.scrollHeight;
}
function removeThinking(){
  const box=document.getElementById('chatBox');
  box.innerHTML=box.innerHTML.replace(/<i>AI Bayan is thinking\.\.\.<\/i>/,"");
}
function clearChat(){document.getElementById('chatBox').innerHTML="";}

/* === SPEECH SYNTHESIS === */
function bayanSpeak(text){
  const speakNow=()=>{
    const v=speechSynthesis.getVoices();
    let voice=v.find(x=>x.name.includes("Google UK English Female")||x.lang==="en-GB");
    if(!voice)voice=v[0];
    const u=new SpeechSynthesisUtterance(text);
    u.voice=voice;u.lang="en-GB";u.rate=0.9;u.pitch=1;u.volume=1;
    speechSynthesis.speak(u);
  };
  if(speechSynthesis.getVoices().length===0){
    speechSynthesis.onvoiceschanged=speakNow;
  }else{speakNow();}
}

/* === OFFLINE AI Bayan === */
function getOfflineAnswer(q){
  q=q.toLowerCase().trim();
  if(q.includes("hello")||q.includes("hi"))return "Hello, nice to see you again!";
  if(q.includes("how are you"))return "I'm great, thank you! How are you?";
  if(q.includes("thank"))return "You're welcome!";
  if(q.includes("bye"))return "Goodbye, see you next time!";
  if(q.includes("noun"))return "A noun names a person, place or thing. Example: cat, teacher, school.";
  if(q.includes("verb"))return "A verb shows an action or state. Example: run, sleep, is.";
  if(q.includes("adjective"))return "An adjective describes a noun. Example: big, kind, happy.";
  if(q.includes("present simple"))return "Present Simple: I play. Used for daily routines.";
  if(q.includes("present continuous"))return "Present Continuous: am/is/are + V-ing. Example: I am reading now.";
  if(q.includes("book"))return "A book is something you read to learn or enjoy stories.";
  return "I'm your Offline AI Bayan ü§ñ Ask me about English grammar, vocabulary, or translations!";
}

/* === MICROPHONE === */
let recognizing=false;let recognition;
function startSpeech(){
  const status=document.getElementById("micStatus");
  if(!('webkitSpeechRecognition'in window||'SpeechRecognition'in window)){
    alert("Speech recognition not supported.");return;
  }
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!recognition){
    recognition=new SR();recognition.lang="en-US";
    recognition.interimResults=false;recognition.maxAlternatives=1;
    recognition.onstart=()=>{status.innerText="üéôÔ∏è Listening...";};
    recognition.onend=()=>{status.innerText="‚úÖ Done listening.";setTimeout(()=>status.innerText="",1500);};
    recognition.onresult=e=>{
      const spoken=e.results[0][0].transcript;
      addMsg("user",spoken);
      const a=getOfflineAnswer(spoken);
      addMsg("ai","<b>(Offline)</b> "+a);
      bayanSpeak(a);
    };
  }
  recognition.start();
}
</script>
</body>
</html>
