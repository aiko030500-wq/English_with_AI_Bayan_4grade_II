<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Bayan Chat ‚Äî English with AI Bayan 4grade II</title>
<style>
  body {
    font-family: Verdana, sans-serif;
    background: linear-gradient(180deg,#fff6e5 0%,#f3e0b8 100%);
    margin: 0; color: #002b5c; text-align: center;
  }
  header {
    background: #003366; color: white; padding: 1rem;
    border-bottom: 5px solid gold;
  }
  main { padding: 1rem; }
  #chatBox {
    max-width: 700px; margin: 0 auto; background: white;
    border: 2px solid gold; border-radius: 12px;
    padding: 10px; height: 360px; overflow-y: auto; text-align: left;
    font-size: 0.95rem;
  }
  .msg { margin:6px 0; padding:6px 10px; border-radius:10px; line-height:1.4; }
  .user { background:#e3f2fd; border-left:3px solid #1565c0; }
  .ai { background:#fff8e1; border-left:3px solid gold; }
  textarea {
    width:95%; max-width:700px; margin-top:10px;
    min-height:60px; border-radius:10px; border:1px solid #ccc;
    font-family:inherit; font-size:1rem; padding:6px;
  }
  .btn {
    display:inline-block;margin:6px;padding:8px 14px;border-radius:10px;
    border:none;background:#003366;color:white;font-weight:bold;cursor:pointer;
  }
  .btn:hover{background:gold;color:#003366;}
  .pulse{display:inline-block;width:12px;height:12px;margin-right:6px;border-radius:50%;
    background:red;animation:pulse 1s infinite;vertical-align:middle;}
  @keyframes pulse{0%{opacity:1;transform:scale(1);}50%{opacity:0.3;transform:scale(1.3);}
    100%{opacity:1;transform:scale(1);}}
</style>
</head>
<body>

<header>
  <h1>üí¨ AI Bayan ‚Äî Online + Offline Auto</h1>
  <p style="font-size:0.9rem;margin:0;">English with AI Bayan 4grade II</p>
</header>

<main>
  <div id="chatBox"></div>
  <textarea id="chatInput" placeholder="Type your question here..."></textarea><br>
  <button class="btn" onclick="askBayan()">Ask AI Bayan</button>
  <button class="btn" onclick="clearChat()">Clear</button>
  <button class="btn" onclick="startSpeech()">üéôÔ∏è Speak</button>
  <p id="micStatus" style="font-size:0.85rem;color:#555;"></p>
</main>

<script>
/* === ONLINE + AUTO-OFFLINE === */
async function askBayan(){
  const input=document.getElementById('chatInput');
  const box=document.getElementById('chatBox');
  const question=input.value.trim();
  if(!question){alert("Type your question first.");return;}
  addMsg("user",question);
  addMsg("ai","<i>AI Bayan is thinking...</i>",true);

  try{
    const controller=new AbortController();
    const timeoutId=setTimeout(()=>controller.abort(),5000);
    const response=await fetch("https://shiny-tree-f78c.aiko030500.workers.dev",{
      method:"POST",headers:{"Content-Type":"application/json"},signal:controller.signal,
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:[
          {role:"system",content:"You are AI Bayan, a kind English teacher for 4th grade kids in Kazakhstan."},
          {role:"user",content:question}
        ]
      })
    });
    clearTimeout(timeoutId);
    if(!response.ok) throw new Error("Server error");
    const data=await response.json();
    const answer=data.choices?.[0]?.message?.content||"";
    removeThinking();
    if(answer){addMsg("ai",answer);bayanSpeak(answer);}
    else throw new Error("Empty");
  }catch{
    removeThinking();
    const offlineAnswer=getOfflineAnswer(question);
    addMsg("ai","<b>(Offline)</b> "+offlineAnswer);
    bayanSpeak(offlineAnswer);
  }
}

function addMsg(role,text,noVoice=false){
  const box=document.getElementById('chatBox');
  box.innerHTML+=`<p class="msg ${role}"><b>${role==="user"?"You":"AI Bayan"}:</b> ${text}</p>`;
  box.scrollTop=box.scrollHeight;
}
function removeThinking(){
  const box=document.getElementById('chatBox');
  box.innerHTML=box.innerHTML.replace(/<p class="msg ai"><b>AI Bayan:<\/b> <i>AI Bayan is thinking\.\.\.<\/i><\/p>/,"");
}
function clearChat(){document.getElementById('chatBox').innerHTML="";}

/* === SPEECH SYNTHESIS === */
function bayanSpeak(text){
  const speakNow=()=>{
    const v=speechSynthesis.getVoices();
    let voice=v.find(x=>x.name.includes("Google UK English Female")||x.lang==="en-GB");
    if(!voice)voice=v[0];
    const u=new SpeechSynthesisUtterance(text);
    u.voice=voice;u.lang="en-GB";u.rate=0.9;u.pitch=1;u.volume=1;
    speechSynthesis.speak(u);
  };
  if(speechSynthesis.getVoices().length===0){
    speechSynthesis.onvoiceschanged=speakNow;
  }else{speakNow();}
}

/* === OFFLINE AI with 13 Themes + Grammar + Translation === */
function getOfflineAnswer(q){
  q=q.toLowerCase().trim();
  const say=t=>`${t}`;
  // Greetings
  if(q.includes("hello")||q.includes("hi"))return say("Hello, nice to see you again!");
  if(q.includes("how are you"))return say("I'm great, thank you! How are you?");
  if(q.includes("thank"))return say("You're welcome!");
  if(q.includes("bye"))return say("Goodbye, see you next time!");

  // Grammar
  if(q.includes("noun"))return "A noun names a person, place or thing. Example: cat, teacher, school.";
  if(q.includes("verb"))return "A verb shows action or state. Example: run, is, sleep.";
  if(q.includes("adjective"))return "An adjective describes a noun. Example: big, kind, happy.";
  if(q.includes("adverb"))return "An adverb describes a verb. Example: quickly, well.";
  if(q.includes("pronoun"))return "A pronoun replaces a noun: he, she, it.";
  if(q.includes("preposition"))return "A preposition shows relation between words: in, on, under.";
  if(q.includes("present simple"))return "Present Simple: I play, you play, he plays ‚Äì for routines.";
  if(q.includes("past simple"))return "Past Simple: I played, she went ‚Äì for finished past actions.";
  if(q.includes("future simple"))return "Future Simple: I will go ‚Äì for future plans.";

  // 13 Themes
  if(q.includes("fun")||q.includes("game"))return "Let's have fun and play English games together!";
  if(q.includes("sport")||q.includes("exercise"))return "Sports keep us healthy ‚Äì run, jump and smile!";
  if(q.includes("world")&&q.includes("sport"))return "People everywhere love football, tennis and basketball.";
  if(q.includes("art")||q.includes("music"))return "Art is creative, music makes us happy üéµ.";
  if(q.includes("museum")||q.includes("dombra"))return "The Dombra is a Kazakh instrument with two strings.";
  if(q.includes("right")||q.includes("responsibility"))return "Children have the right to study, play and be safe.";
  if(q.includes("job")||q.includes("profession"))return "Jobs are important: teacher, doctor, driver help people.";
  if(q.includes("work")||q.includes("worker"))return "People work in schools, offices and hospitals.";
  if(q.includes("help")||q.includes("volunteer"))return "You can help friends and our planet üåç.";
  if(q.includes("kazakhstan")||q.includes("country"))return "Kazakhstan is my country. Its capital is Astana üá∞üáø.";
  if(q.includes("travel")||q.includes("transport"))return "We travel by car, train, plane or bus.";
  if(q.includes("season")||q.includes("weather"))return "Four seasons: spring, summer, autumn and winter.";
  if(q.includes("dream")||q.includes("future"))return "Dream big! You can be a scientist or artist one day.";

  // Translation RU‚ÜíEN
  const tmap={
    "–ø—Ä–∏–≤–µ—Ç":"Hello","–∫–∞–∫ –¥–µ–ª–∞":"How are you?","—Å–ø–∞—Å–∏–±–æ":"Thank you",
    "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è":"Goodbye","–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ":"Good morning","–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä":"Good evening",
    "—Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏":"Good night","—É—á–∏—Ç–µ–ª—å":"Teacher","–¥—Ä—É–∑—å—è":"Friends","–º–æ—è —Å–µ–º—å—è":"My family"
  };
  for(const k in tmap){if(q.includes(k))return `‚Äò${k}‚Äô means ‚Äò${tmap[k]}‚Äô.`; }

  // Mini dictionary command
  if(q.startsWith("translate")){
    const w=q.replace("translate","").trim();
    const dict={
      apple:"—è–±–ª–æ–∫–æ",book:"–∫–Ω–∏–≥–∞",dog:"—Å–æ–±–∞–∫–∞",cat:"–∫–æ—à–∫–∞",school:"—à–∫–æ–ª–∞",
      friend:"–¥—Ä—É–≥",teacher:"—É—á–∏—Ç–µ–ª—å",family:"—Å–µ–º—å—è",sun:"—Å–æ–ª–Ω—Ü–µ",love:"–ª—é–±–æ–≤—å",
      music:"–º—É–∑—ã–∫–∞",sport:"—Å–ø–æ—Ä—Ç",game:"–∏–≥—Ä–∞",dream:"–º–µ—á—Ç–∞",work:"—Ä–∞–±–æ—Ç–∞"
    };
    if(dict[w])return `'${w}' = ${dict[w]}`;
    return say("I don‚Äôt know that word yet, try another one.");
  }

  // Default
  return say("I'm your Offline AI Bayan ü§ñ Ask me about English, grammar or our themes!");
}

/* === MICROPHONE === */
let recognizing=false;let recognition;
function startSpeech(){
  const status=document.getElementById("micStatus");
  if(!('webkitSpeechRecognition'in window||'SpeechRecognition'in window)){
    alert("Speech recognition not supported.");return;
  }
  const beep=t=>{
    const ctx=new AudioContext(),osc=ctx.createOscillator(),g=ctx.createGain();
    osc.connect(g);g.connect(ctx.destination);
    osc.frequency.value=t==="start"?700:400;
    g.gain.setValueAtTime(0.15,ctx.currentTime);
    osc.start();osc.stop(ctx.currentTime+0.15);
  };
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!recognition){
    recognition=new SR();recognition.lang="en-US";
    recognition.interimResults=false;recognition.maxAlternatives=1;
    recognition.onstart=()=>{recognizing=true;status.innerHTML='<span class="pulse"></span> üéôÔ∏è Listening...';beep("start");};
    recognition.onend=()=>{recognizing=false;status.innerText="‚úÖ Done listening.";beep("end");setTimeout(()=>status.innerText="",1500);};
    recognition.onerror=()=>{status.innerText="‚ö†Ô∏è Mic error.";};
    recognition.onresult=e=>{
      const spoken=e.results[0][0].transcript;
      addMsg("user",spoken);
      const a=getOfflineAnswer(spoken);
      addMsg("ai","<b>(Offline)</b> "+a);
      bayanSpeak(a);
    };
  }
  if(!recognizing)recognition.start();
}
</script>
</body>
</html>
